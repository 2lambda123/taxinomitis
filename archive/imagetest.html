<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Figuring out image drop</title>
        <script>
            var addEvent = (function () {
                if (document.addEventListener) {
                    return function (el, type, fn) {
                    if (el && el.nodeName || el === window) {
                        el.addEventListener(type, fn, false);
                    } else if (el && el.length) {
                        for (var i = 0; i < el.length; i++) {
                        addEvent(el[i], type, fn);
                        }
                    }
                    };
                } else {
                    return function (el, type, fn) {
                    if (el && el.nodeName || el === window) {
                        el.attachEvent('on' + type, function () { return fn.call(el, window.event); });
                    } else if (el && el.length) {
                        for (var i = 0; i < el.length; i++) {
                        addEvent(el[i], type, fn);
                        }
                    }
                    };
                }
            })();
        </script>
        <style>
            .failed {
                background-color: #AA4444;
            }

            #drop {
                border: 3px dashed #ccc;
                padding: 10px;
                background: #fff;
                min-height: 500px;
                /*  overflow-y: auto;*/
            }

            #drop .info {
                color: #999;
                text-align: center;
            }

            #drop ul {
                margin: 0;
                padding: 0;
            }

            #drop li {
                border-top: 2px solid #ccc;
                list-style: none;
                padding: 5px;
                font-size: 90%;
            }

            #drop li:first-child {
                border-top: 0;
            }
        </style>
    </head>
    <body>
        <section id="drop">
            <ul>
                <li>Drop here for info about dragged items</li>
            </ul>
        </section>

        <script>
            var lut = []; for (var i=0; i<256; i++) { lut[i] = (i<16?'0':'')+(i).toString(16); }
            function uuid()
            {
            var d0 = Math.random()*0xffffffff|0;
            var d1 = Math.random()*0xffffffff|0;
            var d2 = Math.random()*0xffffffff|0;
            var d3 = Math.random()*0xffffffff|0;
            return lut[d0&0xff]+lut[d0>>8&0xff]+lut[d0>>16&0xff]+lut[d0>>24&0xff]+'-'+
                lut[d1&0xff]+lut[d1>>8&0xff]+'-'+lut[d1>>16&0x0f|0x40]+lut[d1>>24&0xff]+'-'+
                lut[d2&0x3f|0x80]+lut[d2>>8&0xff]+'-'+lut[d2>>16&0xff]+lut[d2>>24&0xff]+
                lut[d3&0xff]+lut[d3>>8&0xff]+lut[d3>>16&0xff]+lut[d3>>24&0xff];
            }
        </script>

        <script>

            function cancel(e) {
                if (e.preventDefault) e.preventDefault(); // required by FF + Safari
                e.dataTransfer.dropEffect = 'copy'; // tells the browser what drop effect is allowed here
                return false; // required by IE
            }

            function entities(s) {
                var e = {
                    '"' : '"',
                    '&' : '&',
                    '<' : '<',
                    '>' : '>'
                };
                var ents = s.replace(/["&<>]/g, function (m) {
                    return e[m];
                });
                return ents;
            }

            function parseHTML(str) {
                var tmp = document.implementation.createHTMLDocument();
                tmp.body.innerHTML = str;
                return tmp;
            }

            function thumbnail(src, id) {
                var img = document.createElement('img');
                img.src = src;
                img.width = 120;
                img.style = 'border: thin black solid';
                img.onerror = invalidImage;
                img.dataset.imgUuid = id;
                return img;
            }

            function invalidImage(evt) {
                var failedElement = document.getElementById(evt.srcElement.dataset.imgUuid);
                failedElement.setAttribute('class', 'failed');
            }


            function parseUrl(url) {
                var result = {};
                url.split("&").forEach(function(part) {
                    if(!part) return;
                    part = part.split("+").join(" "); // replace every + with space, regexp-free version
                    var eq = part.indexOf("=");
                    var key = eq>-1 ? part.substr(0,eq) : part;
                    var val = eq>-1 ? decodeURIComponent(part.substr(eq+1)) : "";
                    var from = key.indexOf("[");
                    if(from==-1) result[decodeURIComponent(key)] = val;
                    else {
                    var to = key.indexOf("]",from);
                    var index = decodeURIComponent(key.substring(from+1,to));
                    key = decodeURIComponent(key.substring(0,from));
                    if(!result[key]) result[key] = [];
                    if(!index) result[key].push(val);
                    else result[key][index] = val;
                    }
                });
                return result;
            }


            var drop = document.querySelector('#drop');

            // Tells the browser that we *can* drop on this target
            addEvent(drop, 'dragover', cancel);
            addEvent(drop, 'dragenter', cancel);


            addEvent(drop, 'drop', function (e) {
                if (e.preventDefault) e.preventDefault(); // stops the browser from redirecting off to the text.


                var li = document.createElement('li');
                var nextUuid = uuid();
                li.id = nextUuid;

                /** THIS IS THE MAGIC: we read from getData based on the content type - so it grabs the item matching that format **/
                if (e.dataTransfer.types) {

                    // for (var i = 0; i < e.dataTransfer.types.length; i++) {
                    //     var type = e.dataTransfer.types[i];
                    //     if (type === 'text/html') {
                    //         li.innerHTML += '<li>' + entities(e.dataTransfer.getData('text/html')) + '</li>';
                    //     }
                    // }

                    var src = e.dataTransfer.getData('text/uri-list');
                    if (src.startsWith('https://www.google.co.uk/imgres?imgurl')) {
                        src = src.substr('https://www.google.co.uk/imgres?'.length);
                        var opts = parseUrl(src);
                        src = opts.imgurl;
                    }
                    else if (src.startsWith('https://www.google.com/imgres?imgurl')) {
                        src = src.substr('https://www.google.com/imgres?'.length);
                        var opts = parseUrl(src);
                        src = opts.imgurl;
                    }
                    else {
                        var linksrc = e.dataTransfer.getData('text/html');
                        var parsed = parseHTML(linksrc);
                        var img = parsed.querySelector('img');
                        if (img) {
                            src = img.src;
                        }
                    }

                    li.innerHTML = '<small>' + src + '</small><br/>';
                    li.appendChild(thumbnail(src, nextUuid));

                    li.innerHTML += '</ul>';
                }
                else {
                    // ... however, if we're IE, we don't have the .types property, so we'll just get the Text value
                    li.innerHTML = e.dataTransfer.getData('Text');
                }



                var ul = drop.querySelector('ul');

                ul.appendChild(li);

                return false;
            });
        </script>
    </body>
</html>
